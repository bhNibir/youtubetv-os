#!/bin/dash
# DietPi Chromium Kiosk Autostart Script for RPi 3B+

# Load resolution from dietpi.txt or fallback
RES_X=$(sed -n '/^[[:blank:]]*SOFTWARE_CHROMIUM_RES_X=/{s/^[^=]*=//p;q}' /boot/dietpi.txt)
RES_Y=$(sed -n '/^[[:blank:]]*SOFTWARE_CHROMIUM_RES_Y=/{s/^[^=]*=//p;q}' /boot/dietpi.txt)

# Chromium options
CHROMIUM_OPTS="--kiosk"
CHROMIUM_OPTS="$CHROMIUM_OPTS --window-size=${RES_X:-1280},${RES_Y:-720}"
CHROMIUM_OPTS="$CHROMIUM_OPTS --window-position=0,0"

# âœ… SmartTV user agent (WebOS-based)
CHROMIUM_OPTS="$CHROMIUM_OPTS --user-agent='Mozilla/5.0 (WebOS; SmartTV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5283.0 Safari/537.36'"

# Kiosk stability and clean startup
CHROMIUM_OPTS="$CHROMIUM_OPTS --noerrdialogs"
CHROMIUM_OPTS="$CHROMIUM_OPTS --disable-restore-session-state"
CHROMIUM_OPTS="$CHROMIUM_OPTS --no-first-run"
CHROMIUM_OPTS="$CHROMIUM_OPTS --enable-features=WebContentsDarkMode"
CHROMIUM_OPTS="$CHROMIUM_OPTS --force-dark-mode"

# Home URL - use Leanback TV version of YouTube
URL="https://www.youtube.com/tv"

# Chromium binary path
FP_CHROMIUM=$(command -v chromium-browser)
[ "$FP_CHROMIUM" ] || FP_CHROMIUM=$(command -v chromium)

# Hide mouse cursor
unclutter -idle 0.5 -root &

# Virtual keyboard (optional)
matchbox-keyboard -d &
sleep 2

# Use startx (non-root)
STARTX='xinit'
[ "$USER" = 'root' ] || STARTX='startx'

# Launch
exec "$STARTX" "$FP_CHROMIUM" $CHROMIUM_OPTS "$URL"
